<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>派克Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 1.5rem; }
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 50; }
    </style>
</head>
<body class="p-6">

    <div id="loading" class="loading">
        <div class="text-xl font-bold text-blue-600">讀取數據中，請稍候...</div>
    </div>

    <div class="max-w-7xl mx-auto space-y-6">
        <div class="flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-xl shadow-sm">
            <h1 class="text-3xl font-bold text-gray-800">派克Dashboard</h1>
            <div class="flex items-center space-x-2">
                <label class="font-medium text-gray-600">基準日期：</label>
                <input type="date" id="datePicker" class="border rounded-lg p-2 bg-gray-50">
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-bold text-gray-700">導師課堂排行榜</h2>
                    <select id="leaderboardRange" class="border rounded px-2 py-1 text-sm bg-gray-50">
                        <option value="7">一星期內</option>
                        <option value="14">兩星期內</option>
                        <option value="30">一個月內</option>
                        <option value="180">半年內</option>
                        <option value="schoolYear">全年內 (9月始)</option>
                    </select>
                </div>
                <div class="overflow-y-auto max-h-80">
                    <table class="w-full text-left">
                        <tbody id="leaderboardBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="card flex flex-col">
                <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">總課堂資料</h2>
                <div class="grid grid-cols-3 gap-2 mb-6 text-center">
                    <div class="bg-blue-50 p-2 rounded-lg">
                        <div class="text-xs text-gray-500">總課堂</div>
                        <div id="totalLessons" class="text-xl font-bold text-blue-600">0</div>
                    </div>
                    <div class="bg-green-50 p-2 rounded-lg">
                        <div class="text-xs text-gray-500">已上</div>
                        <div id="completedLessons" class="text-xl font-bold text-green-600">0</div>
                    </div>
                    <div class="bg-gray-100 p-2 rounded-lg">
                        <div class="text-xs text-gray-500">未上</div>
                        <div id="remainingLessons" class="text-xl font-bold text-gray-600">0</div>
                    </div>
                </div>
                <div class="relative h-48"><canvas id="generalChart"></canvas></div>
            </div>
        </div>

        <div class="card">
            <div class="flex justify-between mb-1">
                <span class="text-sm font-medium text-blue-700">總體進度 (已上 / 總課堂)</span>
                <span id="progressText" class="text-sm font-medium text-blue-700">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="progressBar" class="bg-blue-600 h-4 rounded-full" style="width: 0%"></div>
            </div>
        </div>

        <div class="card">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b pb-2">
                <h2 class="text-xl font-bold text-gray-700">導師個人數值表</h2>
                <select id="tutorSelect" class="mt-2 md:mt-0 border rounded px-4 py-2 bg-gray-50">
                    <option value="">-- 請選擇導師 --</option>
                </select>
            </div>
            <div id="tutorStatsContainer" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <div class="flex justify-between p-4 bg-gray-50 rounded-lg"><span>總課堂</span><span id="tutorTotal" class="font-bold">0</span></div>
                    <div class="flex justify-between p-4 bg-green-50 rounded-lg"><span>已上課堂</span><span id="tutorCompleted" class="font-bold">0</span></div>
                    <div class="flex justify-between p-4 bg-gray-100 rounded-lg"><span>未上課堂</span><span id="tutorRemaining" class="font-bold">0</span></div>
                </div>
                <div class="relative h-48"><canvas id="tutorChart"></canvas></div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQFFF43IJhu4qgR8KiR_Oo9lwv7LkuTcjHzebpTvUd-SnnivG_5GwDT3-JzEncLTxKXbZuQ8LnU90n3/pub?output=csv";
        let rawData = [];
        let charts = {};

        // 強大的日期解析器
        function parseAnyDate(str) {
            if (!str) return null;
            str = str.trim();
            // 處理「2026年2月2日」
            const cnMatch = str.match(/(\d+)年(\d+)月(\d+)日/);
            if (cnMatch) return new Date(cnMatch[1], cnMatch[2]-1, cnMatch[3]);
            
            // 處理「2026/2/2」或「2026-2-2」
            const d = new Date(str);
            return isNaN(d.getTime()) ? null : d;
        }

        // 初始化
        window.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            document.getElementById('datePicker').value = now.toISOString().split('T')[0];

            Papa.parse(SHEET_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                transformHeader: h => h.trim(), // 關鍵：移除欄位名稱前後空格
                complete: (results) => {
                    rawData = results.data;
                    console.log("數據載入成功，範例行：", rawData[0]); // 除錯用
                    document.getElementById('loading').style.display = 'none';
                    initTutorDropdown();
                    render();
                }
            });
        });

        function initTutorDropdown() {
            const select = document.getElementById('tutorSelect');
            const tutors = new Set();
            rawData.forEach(row => {
                const val = row['導師'] || row['G']; // 嘗試抓取欄位
                if (val) val.split('/').forEach(t => tutors.add(t.trim()));
            });
            Array.from(tutors).sort().forEach(t => select.add(new Option(t, t)));
        }

        function render() {
            const refDate = new Date(document.getElementById('datePicker').value);
            refDate.setHours(0,0,0,0);

            // 1. 總覽數據
            let total = 0, done = 0;
            const courses = {};
            rawData.forEach(row => {
                const d = parseAnyDate(row['日期']);
                if (d) {
                    total++;
                    if (d < refDate) done++;
                    const c = row['課程'] || "未分類";
                    courses[c] = (courses[c] || 0) + 1;
                }
            });

            document.getElementById('totalLessons').innerText = total;
            document.getElementById('completedLessons').innerText = done;
            document.getElementById('remainingLessons').innerText = total - done;
            const p = total ? Math.round((done/total)*100) : 0;
            document.getElementById('progressBar').style.width = p + '%';
            document.getElementById('progressText').innerText = p + '%';
            updateChart('generalChart', courses);

            // 2. 排行榜
            updateLeaderboard(refDate);

            // 3. 個人數據
            updateIndividual(refDate);
        }

        function updateLeaderboard(refDate) {
            const range = document.getElementById('leaderboardRange').value;
            let start = new Date(refDate), end = new Date(refDate);
            
            if (range === 'schoolYear') start = new Date(2025, 8, 1), end = new Date(2030,0,1);
            else end.setDate(refDate.getDate() + parseInt(range));

            const counts = {};
            rawData.forEach(row => {
                const d = parseAnyDate(row['日期']);
                const tStr = row['導師'];
                if (d >= start && d <= end && tStr) {
                    tStr.split('/').forEach(t => {
                        t = t.trim();
                        if(t) counts[t] = (counts[t] || 0) + 1;
                    });
                }
            });

            const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]);
            document.getElementById('leaderboardBody').innerHTML = sorted.map(([name, count], i) => `
                <tr class="border-b"><td class="py-2">#${i+1} ${name}</td><td class="text-right">${count} 堂</td></tr>
            `).join('');
        }

        function updateIndividual(refDate) {
            const name = document.getElementById('tutorSelect').value;
            if (!name) return;
            document.getElementById('tutorStatsContainer').classList.remove('hidden');

            let t = 0, d = 0;
            const cTypes = {};
            rawData.forEach(row => {
                const tutors = (row['導師'] || "").split('/').map(s => s.trim());
                if (tutors.includes(name)) {
                    const lDate = parseAnyDate(row['日期']);
                    if (lDate) {
                        t++;
                        if (lDate < refDate) d++;
                        const c = row['課程'] || "其他";
                        cTypes[c] = (cTypes[c] || 0) + 1;
                    }
                }
            });
            document.getElementById('tutorTotal').innerText = t;
            document.getElementById('tutorCompleted').innerText = d;
            document.getElementById('tutorRemaining').innerText = t - d;
            updateChart('tutorChart', cTypes);
        }

        function updateChart(id, dataObj) {
            if (charts[id]) charts[id].destroy();
            const ctx = document.getElementById(id).getContext('2d');
            charts[id] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dataObj),
                    datasets: [{ data: Object.values(dataObj), backgroundColor: ['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6'] }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        // 監聽事件
        document.getElementById('datePicker').onchange = render;
        document.getElementById('leaderboardRange').onchange = render;
        document.getElementById('tutorSelect').onchange = render;
    </script>
</body>
</html>
