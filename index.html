<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>派克課堂Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); height: 100%; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        .scroll-list { max-height: 250px; overflow-y: auto; }
        .scroll-list::-webkit-scrollbar { width: 6px; }
        .scroll-list::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
    </style>
</head>
<body class="p-6">

    <header class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">派克課堂Dashboard</h1>
        <div class="bg-white p-4 rounded-lg shadow flex flex-wrap gap-4 items-center">
            <div>
                <label class="block text-sm font-medium text-gray-700">基準日期</label>
                <input type="date" id="baseDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm border p-2">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">時間範圍</label>
                <select id="timeRange" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm border p-2">
                    <option value="7">一星期內</option>
                    <option value="14">兩星期內</option>
                    <option value="30">一個月內</option>
                    <option value="180">半年內</option>
                    <option value="all" selected>全年內 (9月始)</option>
                </select>
            </div>
            <div class="ml-auto">
                <button onclick="fetchAndProcessData()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">重新整理資料</button>
            </div>
        </div>
    </header>

    <section class="mb-8">
        <h2 class="text-xl font-bold text-gray-700 mb-4 border-l-4 border-blue-500 pl-3">第一部分：課堂資料總匯</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="card">
                <h3 class="text-lg font-semibold mb-3 text-gray-800">導師課堂排行榜</h3>
                <div class="scroll-list">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                            <tr><th class="py-2 px-2">排名</th><th class="py-2 px-2">導師</th><th class="py-2 px-2 text-right">堂數</th></tr>
                        </thead>
                        <tbody id="tutorRankList"></tbody>
                    </table>
                </div>
            </div>
            <div class="card flex flex-col items-center">
                <h3 class="text-lg font-semibold mb-3 text-gray-800 w-full">課程種類分佈</h3>
                <div class="chart-container"><canvas id="courseTypeChart"></canvas></div>
            </div>
            <div class="card">
                <h3 class="text-lg font-semibold mb-3 text-gray-800">每月課堂趨勢</h3>
                <div class="chart-container"><canvas id="monthlyTrendChart"></canvas></div>
            </div>
        </div>
    </section>

    <section class="mb-8">
        <h2 class="text-xl font-bold text-gray-700 mb-4 border-l-4 border-green-500 pl-3">第二部分：總課程進度</h2>
        <div class="card">
            <div class="flex justify-between mb-1">
                <span class="text-base font-medium text-blue-700">已完成課堂 / 總課堂</span>
                <span class="text-sm font-medium text-blue-700" id="progressText">0 / 0</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-6"><div id="progressBar" class="bg-blue-600 h-6 rounded-full text-xs font-medium text-blue-100 text-center p-1 leading-none" style="width: 0%">0%</div></div>
        </div>
    </section>

    <section class="mb-8">
        <div class="flex items-center gap-4 mb-4">
            <h2 class="text-xl font-bold text-gray-700 border-l-4 border-purple-500 pl-3">第三部分：導師個人數值表</h2>
            <select id="individualTutorSelect" class="border-gray-300 rounded shadow-sm border p-1 text-sm"><option value="">載入中...</option></select>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="card flex flex-col justify-center items-center text-center space-y-4">
                <div><div class="text-gray-500 text-sm">總課堂</div><div class="text-3xl font-bold text-purple-600" id="indTotal">0</div></div>
                <div class="grid grid-cols-2 gap-8 w-full">
                    <div><div class="text-gray-500 text-sm">已上</div><div class="text-xl font-bold text-green-600" id="indDone">0</div></div>
                    <div><div class="text-gray-500 text-sm">未上</div><div class="text-xl font-bold text-red-500" id="indPending">0</div></div>
                </div>
            </div>
            <div class="card flex flex-col items-center">
                <h3 class="text-lg font-semibold mb-3 text-gray-800 w-full">教授課程類型</h3>
                <div class="chart-container"><canvas id="indTypeChart"></canvas></div>
            </div>
            <div class="card"><h3 class="text-lg font-semibold mb-3 text-gray-800">個人每月趨勢</h3><div class="chart-container"><canvas id="indTrendChart"></canvas></div></div>
        </div>
    </section>

    <section class="mb-12">
        <h2 class="text-xl font-bold text-gray-700 mb-4 border-l-4 border-orange-500 pl-3">第四部分：其他資料</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="card">
                <select id="ratioTypeSelect" class="w-full mb-3 border p-1 rounded text-sm"><option value="">選擇課程種類...</option></select>
                <div class="scroll-list"><table class="w-full text-sm text-left"><tbody id="typeTutorRankList"></tbody></table></div>
            </div>
            <div class="card"><h3 class="text-lg font-semibold mb-3 text-gray-800">學校排行榜</h3><div class="scroll-list"><table class="w-full text-sm text-left"><tbody id="schoolRankList"></tbody></table></div></div>
            <div class="card"><h3 class="text-lg font-semibold mb-3 text-gray-800">全職/兼職比</h3><div class="chart-container"><canvas id="ftPtChart"></canvas></div></div>
        </div>
    </section>

    <div id="loading" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded shadow-lg flex flex-col items-center"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-3"></div><p>資料處理中...</p></div>
    </div>

    <script>
        // 註冊插件
        Chart.register(ChartDataLabels);

        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQFFF43IJhu4qgR8KiR_Oo9lwv7LkuTcjHzebpTvUd-SnnivG_5GwDT3-JzEncLTxKXbZuQ8LnU90n3/pub?output=csv';
        const FULL_TIME_STAFF = ['Harry', 'Zoe', 'Ian', 'Chris', 'Cola'];
        let RAW_DATA = [], FILTERED_DATA = [], YEAR_DATA = [], charts = {};

        document.getElementById('baseDate').valueAsDate = new Date();

        window.onload = () => {
            fetchAndProcessData();
            document.getElementById('baseDate').addEventListener('change', updateDashboard);
            document.getElementById('timeRange').addEventListener('change', updateDashboard);
            document.getElementById('individualTutorSelect').addEventListener('change', updateIndividualStats);
            document.getElementById('ratioTypeSelect').addEventListener('change', updateTypeTutorRank);
        };

        // 圓形圖標籤共用設定
        const pieOptions = {
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } },
                datalabels: {
                    color: '#fff',
                    font: { weight: 'bold', size: 11 },
                    formatter: (value, ctx) => {
                        let sum = 0;
                        let dataArr = ctx.chart.data.datasets[0].data;
                        dataArr.map(data => { sum += data; });
                        let percentage = (value * 100 / sum).toFixed(1) + "%";
                        return value + "\n(" + percentage + ")";
                    },
                    display: (ctx) => {
                        return ctx.dataset.data[ctx.dataIndex] > 0; // 只顯示大於0的
                    }
                }
            }
        };

        function fetchAndProcessData() {
            document.getElementById('loading').style.display = 'flex';
            Papa.parse(CSV_URL, {
                download: true, header: true,
                complete: (results) => {
                    RAW_DATA = results.data.filter(row => row['學校'] && row['日期']).map(row => {
                        const m = row['日期'].match(/(\d+)年(\d+)月(\d+)日/);
                        const tutors = (row['導師'] || "").split('/').map(t => t.trim()).filter(t => t);
                        return {
                            school: row['學校'], type: row['課程種類'], date: m ? new Date(m[1], m[2]-1, m[3]) : null,
                            tutors: tutors, isFullTime: tutors.some(t => FULL_TIME_STAFF.includes(t))
                        };
                    });
                    populateDropdowns();
                    updateDashboard();
                    document.getElementById('loading').style.display = 'none';
                }
            });
        }

        function populateDropdowns() {
            const tutors = new Set(), types = new Set();
            RAW_DATA.forEach(d => { d.tutors.forEach(t => tutors.add(t)); if(d.type) types.add(d.type); });
            const tSel = document.getElementById('individualTutorSelect');
            tSel.innerHTML = '<option value="">選擇導師...</option>';
            Array.from(tutors).sort().forEach(t => tSel.add(new Option(t, t)));
            const rSel = document.getElementById('ratioTypeSelect');
            rSel.innerHTML = '<option value="">選擇課程種類...</option>';
            Array.from(types).sort().forEach(t => rSel.add(new Option(t, t)));
        }

        function updateDashboard() {
            const base = new Date(document.getElementById('baseDate').value);
            const range = document.getElementById('timeRange').value;
            const academicStart = new Date(2025, 8, 1), academicEnd = new Date(2026, 7, 31);
            
            YEAR_DATA = RAW_DATA.filter(d => d.date >= academicStart && d.date <= academicEnd);
            if(range === 'all') { FILTERED_DATA = YEAR_DATA; } 
            else {
                const end = new Date(base); end.setDate(base.getDate() + parseInt(range));
                FILTERED_DATA = RAW_DATA.filter(d => d.date >= base && d.date <= end);
            }

            renderTutorRank(FILTERED_DATA);
            renderPie('courseTypeChart', FILTERED_DATA, 'type');
            renderTrend('monthlyTrendChart', YEAR_DATA, '總課堂');
            renderProgress(YEAR_DATA, base);
            renderSchoolRank();
            renderFT PT(YEAR_DATA);
            updateIndividualStats();
            updateTypeTutorRank();
        }

        function renderPie(id, data, key) {
            const counts = {};
            data.forEach(d => { if(d[key]) counts[d[key]] = (counts[d[key]] || 0) + 1; });
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{ data: Object.values(counts), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'] }]
                },
                options: pieOptions
            });
        }

        function renderTutorRank(data) {
            const counts = {};
            data.forEach(d => d.tutors.forEach(t => counts[t] = (counts[t] || 0) + 1));
            const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]);
            document.getElementById('tutorRankList').innerHTML = sorted.map((item, i) => 
                `<tr class="border-b"><td class="py-2 px-2">${i+1}</td><td class="py-2 px-2">${item[0]}</td><td class="py-2 px-2 text-right font-bold text-blue-600">${item[1]}</td></tr>`).join('');
        }

        function renderTrend(id, data, label) {
            const labels = ['9月','10月','11月','12月','1月','2月','3月','4月','5月','6月','7月','8月'];
            const counts = new Array(12).fill(0);
            data.forEach(d => {
                const m = d.date.getMonth();
                const idx = (m >= 8) ? (m - 8) : (m + 4);
                if(idx >= 0 && idx < 12) counts[idx]++;
            });
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: 'line',
                data: { labels, datasets: [{ label, data: counts, borderColor: '#3b82f6', fill: true, backgroundColor: 'rgba(59,130,246,0.1)', tension: 0.3 }] },
                options: { maintainAspectRatio: false, plugins: { datalabels: { display: false } } }
            });
        }

        function renderProgress(data, today) {
            const total = data.length, done = data.filter(d => d.date < today).length;
            const pct = total ? Math.round(done/total*100) : 0;
            document.getElementById('progressText').innerText = `${done} / ${total}`;
            document.getElementById('progressBar').style.width = pct+'%';
            document.getElementById('progressBar').innerText = pct+'%';
        }

        function updateIndividualStats() {
            const t = document.getElementById('individualTutorSelect').value;
            if(!t) return;
            const data = YEAR_DATA.filter(d => d.tutors.includes(t));
            const today = new Date(document.getElementById('baseDate').value);
            const done = data.filter(d => d.date < today).length;
            document.getElementById('indTotal').innerText = data.length;
            document.getElementById('indDone').innerText = done;
            document.getElementById('indPending').innerText = data.length - done;
            renderPie('indTypeChart', data, 'type');
            renderTrend('indTrendChart', data, t+'的課堂');
        }

        function updateTypeTutorRank() {
            const type = document.getElementById('ratioTypeSelect').value;
            if(!type) return;
            const counts = {};
            YEAR_DATA.filter(d => d.type === type).forEach(d => d.tutors.forEach(t => counts[t] = (counts[t] || 0) + 1));
            const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]);
            document.getElementById('typeTutorRankList').innerHTML = sorted.map((item, i) => 
                `<tr class="border-b"><td class="py-2 px-2 text-gray-400">${i+1}</td><td class="py-2 px-2">${item[0]}</td><td class="py-2 px-2 text-right font-bold text-orange-500">${item[1]}</td></tr>`).join('');
        }

        function renderSchoolRank() {
            const counts = {};
            YEAR_DATA.forEach(d => counts[d.school] = (counts[d.school] || 0) + 1);
            const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0,10);
            document.getElementById('schoolRankList').innerHTML = sorted.map((item, i) => 
                `<tr class="border-b"><td class="py-2 px-2 text-gray-400">${i+1}</td><td class="py-2 px-2 truncate max-w-[120px]">${item[0]}</td><td class="py-2 px-2 text-right font-bold">${item[1]}</td></tr>`).join('');
        }

        function renderFTPT(data) {
            let ft = 0, pt = 0;
            data.forEach(d => d.tutors.forEach(t => FULL_TIME_STAFF.includes(t) ? ft++ : pt++));
            if(charts['ftpt']) charts['ftpt'].destroy();
            charts['ftpt'] = new Chart(document.getElementById('ftPtChart'), {
                type: 'pie',
                data: { labels: ['全職', '兼職'], datasets: [{ data: [ft, pt], backgroundColor: ['#2563eb', '#14b8a6'] }] },
                options: pieOptions
            });
        }
    </script>
</body>
</html>
